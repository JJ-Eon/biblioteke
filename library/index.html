<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ðŸ“š Bibloteka Lasgush Poradeci</title>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Nunito:wght@300;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <style>
    :root {
      --bg: #F5F1E3;
      --text: #3E2723;
      --card-bg: rgba(255, 255, 255, 0.98);
      --accent: #6D4C41;
      --accent-hover: #5D4037;
      --gold: #FFD700;
    }
    body.dark-mode {
      --bg: #121212;
      --text: #E0E0E0;
      --card-bg: #1E1E1E;
      --accent: #8D6E63;
      --accent-hover: #A1887F;
    }
    
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Nunito', sans-serif;
      background-color: var(--bg);
      color: var(--text);
      min-height: 100vh;
      transition: background-color 0.3s, color 0.3s;
      -webkit-font-smoothing: antialiased;
    }

    /* --- PORTAL STYLES --- */
    .portal-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
      animation: fadeIn 0.8s ease-out;
    }
    
    .landing-card {
      max-width: 600px;
      width: 100%;
      text-align: center;
      padding: 50px 40px;
      background: var(--card-bg);
      border-radius: 20px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.1);
      position: relative;
    }
    body.dark-mode .landing-card { box-shadow: 0 15px 35px rgba(0,0,0,0.4); }

    h1 {
      font-family: 'Playfair Display', serif;
      font-size: 3rem;
      margin-bottom: 10px;
      color: var(--text);
      line-height: 1.1;
    }
    h2 {
      font-family: 'Playfair Display', serif;
      font-size: 1.5rem;
      margin-bottom: 30px;
      color: var(--accent);
      font-weight: 400;
      font-style: italic;
    }
    p.quote {
      font-size: 1.1rem;
      color: var(--text);
      opacity: 0.8;
      margin: 30px auto;
      font-style: italic;
      border-top: 1px solid var(--accent);
      border-bottom: 1px solid var(--accent);
      padding: 20px 0;
      width: 80%;
    }
    
    .btn-group {
      display: flex;
      flex-direction: column;
      gap: 15px;
      align-items: center;
      margin-top: 40px;
    }
    .cta-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 16px 40px;
      font-size: 1.1rem;
      font-weight: 600;
      color: #fff;
      background-color: var(--accent);
      border: none;
      border-radius: 50px;
      text-decoration: none;
      transition: all 0.3s ease;
      width: 100%;
      max-width: 320px;
      box-shadow: 0 4px 15px rgba(109, 76, 65, 0.3);
      cursor: pointer;
    }
    .cta-button:hover {
      background-color: var(--accent-hover);
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(109, 76, 65, 0.4);
    }
    .cta-button:disabled {
      background-color: #9e9e9e;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .cta-button.secondary {
      background-color: transparent;
      border: 2px solid var(--accent);
      color: var(--accent);
      box-shadow: none;
    }
    .cta-button.secondary:hover {
      background-color: var(--accent);
      color: #fff;
    }

    .dark-mode-toggle {
      position: absolute;
      top: 20px;
      right: 20px;
      background: none;
      border: 1px solid var(--text);
      color: var(--text);
      width: 40px; height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.3s;
    }
    .dark-mode-toggle:hover {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }

    .back-link {
        position: absolute;
        top: 20px;
        left: 20px;
        color: var(--text);
        text-decoration: none;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: color 0.3s;
        z-index: 10;
    }
    .back-link:hover { color: var(--accent); }

    /* --- GUEST DASHBOARD STYLES --- */
    #guest-dashboard {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100vh;
      background: var(--bg);
      z-index: 2000;
      overflow-y: auto;
      padding: 20px;
      animation: slideUp 0.5s ease-out;
    }
    
    .dashboard-header {
      max-width: 1200px;
      margin: 0 auto 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 20px;
      border-bottom: 2px solid rgba(0,0,0,0.05);
    }
    body.dark-mode .dashboard-header { border-bottom-color: rgba(255,255,255,0.1); }

    .header-title h2 { font-size: 2rem; margin: 0; color: var(--accent); }
    .header-title p { margin: 5px 0 0; opacity: 0.7; }

    .search-bar {
      max-width: 600px;
      margin: 0 auto 20px;
      position: relative;
    }
    .search-bar input {
      width: 100%;
      padding: 15px 25px;
      border-radius: 50px;
      border: none;
      background: #fff;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      font-size: 1rem;
      font-family: inherit;
      color: #333; /* Ensuring dark text in light mode */
    }
    body.dark-mode .search-bar input { 
      background: #1E1E1E; 
      color: #fff; 
    }

    .filters-container {
      max-width: 1000px;
      margin: 0 auto 15px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      background: rgba(255,255,255,0.4);
      padding: 15px;
      border-radius: 15px;
    }
    body.dark-mode .filters-container { background: rgba(255,255,255,0.05); }

    .total-count {
      text-align: center;
      margin-bottom: 30px;
      font-weight: bold;
      color: var(--accent);
      font-size: 1.1rem;
    }

    .filter-select {
      padding: 10px 15px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.1);
      background: #fff;
      font-family: inherit;
      cursor: pointer;
      color: var(--text);
    }
    body.dark-mode .filter-select { background: #2C2C2C; border-color: #444; }

    .book-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 25px;
      max-width: 1200px;
      margin: 0 auto 30px;
    }

    .book-card {
      background: #fff;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      justify-content: space-between; /* Fix overlap by distributing space */
      transition: transform 0.3s;
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(0,0,0,0.03);
      cursor: pointer;
      height: 100%;
    }
    body.dark-mode .book-card { background: #1E1E1E; border-color: #333; }
    .book-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); border-color: var(--accent); }

    .book-icon {
      font-size: 3rem; margin-bottom: 15px; color: var(--accent); opacity: 0.9;
    }
    .book-content {
      width: 100%;
      margin-bottom: 15px;
    }
    .book-title { 
      font-weight: 700; 
      font-size: 1.1rem; 
      margin-bottom: 5px; 
      color: var(--text); 
      line-height: 1.3;
      word-wrap: break-word; /* Prevent text overflow */
    }
    .book-author { 
      font-size: 0.9rem; 
      color: #777; 
      margin-bottom: 10px;
      word-wrap: break-word;
    }
    
    .badge {
      display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; background: #eee; color: #555; margin-top: auto;
    }

    /* --- MODAL STYLES --- */
    .modal {
      display: none; 
      position: fixed; 
      z-index: 3000; 
      left: 0; top: 0; 
      width: 100%; height: 100%; 
      overflow: auto; 
      background-color: rgba(0,0,0,0.6); 
      align-items: center; 
      justify-content: center;
      backdrop-filter: blur(5px);
      animation: fadeIn 0.3s;
    }
    .modal-content {
      background-color: var(--card-bg);
      margin: auto;
      padding: 30px;
      border-radius: 20px;
      width: 90%; 
      max-width: 550px;
      box-shadow: 0 25px 50px rgba(0,0,0,0.2);
      position: relative;
      animation: slideUp 0.3s;
      color: var(--text);
    }
    .close-modal {
      position: absolute;
      right: 25px;
      top: 20px;
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: color 0.2s;
      z-index: 10;
    }
    .close-modal:hover { color: var(--accent); }
    
    /* Detail View specific */
    .detail-header {
      text-align: center;
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(0,0,0,0.1);
    }
    .detail-icon { font-size: 4rem; color: var(--accent); margin-bottom: 15px; }
    .detail-title { font-size: 1.8rem; font-family: 'Playfair Display', serif; margin-bottom: 5px; line-height: 1.2; word-wrap: break-word; }
    .detail-author { font-size: 1.1rem; opacity: 0.8; }
    .detail-body { margin-bottom: 25px; line-height: 1.6; }
    .detail-meta { 
      display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; justify-content: center;
    }
    
    .form-group { margin-bottom: 20px; text-align: left; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; }
    .form-group input, .form-group select {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.1);
      background: rgba(255,255,255,0.8);
      font-family: inherit;
      box-sizing: border-box;
      color: #333; /* Dark text for inputs */
    }
    body.dark-mode .form-group input, body.dark-mode .form-group select {
      background: #2C2C2C; border-color: #444; color: #fff;
    }
    .form-group input:focus, .form-group select:focus {
        outline: none; border-color: var(--accent);
    }
    
    .book-summary {
      display: flex; gap: 15px; align-items: center; margin-bottom: 25px;
      background: rgba(0,0,0,0.03); padding: 15px; border-radius: 15px;
    }
    body.dark-mode .book-summary { background: rgba(255,255,255,0.05); }
    .summary-icon { font-size: 2rem; color: var(--accent); }

    audio { width: 100%; height: 40px; margin-top: 15px; border-radius: 20px; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    @media (max-width: 600px) {
      h1 { font-size: 2.5rem; }
      .landing-card { padding: 30px 20px; }
      .dashboard-header { flex-direction: column; text-align: center; gap: 15px; }
      .filters-container { flex-direction: column; }
      .filter-select { width: 100%; }
      .detail-title { font-size: 1.5rem; }
    }
  </style>
  <script type="importmap">
  {
    "imports": {
      "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
      "firebase/database": "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js"
    }
  }
  </script>
<link rel="stylesheet" href="/index.css">
</head>
<body>
  <div id="portal-view">
    <a href="../index.html" class="back-link">
      <i class="fas fa-arrow-left"></i> Shkolla
    </a>

    <div class="portal-wrapper">
      <button class="dark-mode-toggle" onclick="toggleDarkMode()"><i class="fas fa-moon"></i></button>

      <div class="landing-card">
        <h1>Biblioteka<br>"Lasgush Poradeci"</h1>
        <h2>Eksploroni botÃ«n e pafundme tÃ« librave</h2>
        
        <p class="quote">"NjÃ« libÃ«r i mirÃ« Ã«shtÃ« njÃ« mik qÃ« nuk tÃ« tradhton kurrÃ«."</p>
        
        <div class="btn-group">
          <a href="login.html" class="cta-button">
            <i class="fas fa-sign-in-alt"></i> Hyr / Regjistrohu
          </a>
          <button onclick="openGuestDashboard()" class="cta-button secondary">
            <i class="fas fa-user-secret"></i> Hyr si Vizitor
          </button>
        </div>

        <div style="margin-top: 30px; font-size: 0.9rem; opacity: 0.7;">
          &copy; 2026 Shkolla 9-VjeÃ§are "Lasgush Poradeci"
        </div>
      </div>
    </div>
  </div>

  <!-- Full Screen Guest Dashboard -->
  <div id="guest-dashboard">
    <div class="dashboard-header">
      <div class="header-title">
        <h2><i class="fas fa-book-open"></i> Katalogu Dixhital</h2>
        <p>Shfletoni koleksionin tonÃ« (Pamje pÃ«r VizitorÃ«)</p>
      </div>
      <div style="display:flex; gap:10px; align-items:center;">
          <button class="dark-mode-toggle" style="position:static; margin:0;" onclick="toggleDarkMode()"><i class="fas fa-moon"></i></button>
          <button onclick="closeGuestDashboard()" class="cta-button secondary" style="padding: 10px 20px; font-size: 1rem; width: auto;">
            <i class="fas fa-times"></i> Mbyll
          </button>
      </div>
    </div>

    <div class="search-bar">
      <input type="text" id="guest-search" placeholder="KÃ«rko sipas titullit ose autorit..." oninput="resetAndFilter()">
    </div>

    <div class="filters-container">
      <select id="filter-class" class="filter-select" onchange="resetAndFilter()">
        <option value="all">TÃ« gjitha klasat</option>
        <option value="1">Klasa 1</option>
        <option value="2">Klasa 2</option>
        <option value="3">Klasa 3</option>
        <option value="4">Klasa 4</option>
        <option value="5">Klasa 5</option>
        <option value="6">Klasa 6</option>
        <option value="7">Klasa 7</option>
        <option value="8">Klasa 8</option>
        <option value="9">Klasa 9</option>
      </select>
      
      <select id="filter-genre" class="filter-select" onchange="resetAndFilter()">
        <option value="all">TÃ« gjitha zhanret</option>
        <option value="Roman">Roman</option>
        <option value="Poezi">Poezi</option>
        <option value="Histori">Histori</option>
        <option value="ShkencÃ«">ShkencÃ«</option>
        <option value="TjetÃ«r">TjetÃ«r</option>
      </select>

      <select id="filter-status" class="filter-select" onchange="resetAndFilter()">
        <option value="all">TÃ« gjitha statuset</option>
        <option value="available">TÃ« DisponueshÃ«m</option>
      </select>
    </div>

    <div id="total-count" class="total-count"></div>

    <div id="guest-book-list" class="book-grid">
      <p style="grid-column: 1/-1; text-align: center; font-size: 1.2rem; margin-top: 50px; opacity: 0.6;">
        <i class="fas fa-spinner fa-spin"></i> Duke ngarkuar bibliotekÃ«n...
      </p>
    </div>
  </div>

  <!-- Book Detail Modal -->
  <div id="book-detail-modal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeBookDetail()">&times;</span>
      
      <div id="detail-content">
        <!-- Content injected by JS -->
      </div>
    </div>
  </div>

  <!-- Borrow Modal -->
  <div id="borrow-modal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeBorrowModal()">&times;</span>
      <h2 style="margin-top:0; margin-bottom:20px; font-size:1.8rem;">KÃ«rkesÃ« pÃ«r TÃ«rheqje</h2>
      
      <div class="book-summary">
        <div class="summary-icon"><i class="fas fa-book"></i></div>
        <div>
          <div id="modal-book-title" style="font-weight:bold; font-size:1.1rem;"></div>
          <div id="modal-book-author" style="font-size:0.9rem; opacity:0.8;"></div>
        </div>
      </div>

      <form id="borrow-form" onsubmit="submitBorrowRequest(event)">
        <input type="hidden" id="borrow-book-id">
        <input type="hidden" id="borrow-book-title-hidden">
        
        <div class="form-group">
          <label>Emri dhe Mbiemri</label>
          <input type="text" id="borrow-name" required placeholder="Shkruani emrin tuaj tÃ« plotÃ«">
        </div>
        
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="borrow-email" required placeholder="email@shembull.com">
        </div>
        
        <div class="form-group">
          <label>Klasa</label>
          <select id="borrow-class" required>
            <option value="">Zgjidhni klasÃ«n</option>
            <option value="1">Klasa 1</option>
            <option value="2">Klasa 2</option>
            <option value="3">Klasa 3</option>
            <option value="4">Klasa 4</option>
            <option value="5">Klasa 5</option>
            <option value="6">Klasa 6</option>
            <option value="7">Klasa 7</option>
            <option value="8">Klasa 8</option>
            <option value="9">Klasa 9</option>
            <option value="Staf">Staf Pedagogjik</option>
          </select>
        </div>

        <button type="submit" class="cta-button" style="width:100%;">
          <i class="fas fa-paper-plane"></i> DÃ«rgo KÃ«rkesÃ«n
        </button>
      </form>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "firebase/app";
    import { getDatabase, ref, onValue, push } from "firebase/database";

    // Initialize Theme
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
      document.body.classList.add('dark-mode');
      document.querySelectorAll('.dark-mode-toggle i').forEach(el => el.classList.replace('fa-moon', 'fa-sun'));
    }

    window.toggleDarkMode = () => {
      document.body.classList.toggle('dark-mode');
      const isDark = document.body.classList.contains('dark-mode');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      
      document.querySelectorAll('.dark-mode-toggle i').forEach(el => {
        el.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
      });
    }

    const firebaseConfig = {
      apiKey: "AIzaSyBO5IVsYnIo9-HB3x-aFYWo00nQHeTJl-A",
      authDomain: "library-system-18d69.firebaseapp.com",
      databaseURL: "https://library-system-18d69-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "library-system-18d69",
      storageBucket: "library-system-18d69.appspot.com",
      messagingSenderId: "888263371866",
      appId: "1:888263371866:web:67e59dc03131d3bcfa7c63"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let allBooks = [];
    let filteredBooks = [];

    // --- Helper Functions ---
    function convertDriveLink(link) {
      if (!link) return null;
      const patterns = [
        /\/file\/d\/([a-zA-Z0-9_-]+)/,
        /id=([a-zA-Z0-9_-]+)/,
        /\/open\?id=([a-zA-Z0-9_-]+)/
      ];
      for (let pattern of patterns) {
        const match = link.match(pattern);
        if (match && match[1]) {
          return `https://drive.google.com/uc?export=download&id=${match[1]}`;
        }
      }
      return link;
    }

    function escapeHtml(text) { return text ? text.toString().replace(/</g, "&lt;").replace(/>/g, "&gt;") : ''; }

    // --- Dashboard Logic ---
    window.openGuestDashboard = () => {
      document.getElementById('portal-view').style.display = 'none';
      document.getElementById('guest-dashboard').style.display = 'block';
      if(allBooks.length === 0) fetchBooks();
    };

    window.closeGuestDashboard = () => {
      document.getElementById('guest-dashboard').style.display = 'none';
      document.getElementById('portal-view').style.display = 'block'; // Portal wrapper handles centering
    };

    // --- Detail Modal Logic ---
    window.openBookDetail = (bookId) => {
      const book = allBooks.find(b => b.id === bookId);
      if(!book) return;

      const qty = book.quantity || 0;
      let statusHtml = '';
      let actionBtn = '';

      if (qty > 0) {
        statusHtml = `<span class="badge" style="background:#e8f5e9; color:#2e7d32; font-size:0.9rem;">E Disponueshme (${qty})</span>`;
        actionBtn = `
          <button onclick="openBorrowModal('${book.id}')" class="cta-button" style="width:100%; margin-top:20px;">
            <i class="fas fa-hand-holding-heart"></i> TÃ«rhiq Librin
          </button>
        `;
      } else {
        statusHtml = `<span class="badge" style="background:#ffebee; color:#c62828; font-size:0.9rem;">E ZÃ«nÃ« (0)</span>`;
        actionBtn = `
          <button disabled class="cta-button secondary" style="width:100%; margin-top:20px; opacity:0.5; cursor:not-allowed;">
            <i class="fas fa-clock"></i> I ZÃ«nÃ« momentalisht
          </button>
        `;
      }

      let audioHtml = '';
      if(book.audioUrl) {
        const stream = convertDriveLink(book.audioUrl);
        audioHtml = `<audio controls src="${stream}" preload="none" style="width:100%;">Audio jo e suportuar.</audio>`;
      }

      const html = `
        <div class="detail-header">
          <div class="detail-icon"><i class="fas fa-book"></i></div>
          <div class="detail-title">${escapeHtml(book.title)}</div>
          <div class="detail-author">nga ${escapeHtml(book.author)}</div>
        </div>
        
        <div class="detail-meta">
           ${statusHtml}
           <span class="badge" style="background:#e3f2fd; color:#1565c0; font-size:0.9rem;">${escapeHtml(book.genre)}</span>
           <span class="badge" style="background:#f3e5f5; color:#7b1fa2; font-size:0.9rem;">Rekomanduar: Kl. ${book.recommended || 'TÃ« gjitha'}</span>
        </div>

        <div class="detail-body">
          <strong>PÃ«rshkrimi:</strong><br>
          <div style="margin-top:5px; opacity:0.9;">
            ${escapeHtml(book.description || 'Nuk ka pÃ«rshkrim pÃ«r kÃ«tÃ« libÃ«r.')}
          </div>
          ${audioHtml}
        </div>

        ${actionBtn}
      `;

      document.getElementById('detail-content').innerHTML = html;
      document.getElementById('book-detail-modal').style.display = 'flex';
    };

    window.closeBookDetail = () => {
      document.getElementById('book-detail-modal').style.display = 'none';
    };

    // --- Borrow Modal Logic ---
    window.openBorrowModal = (bookId) => {
      // Close detail modal if open to prevent stacking issues (optional, or keep generic)
      closeBookDetail(); 
      
      const book = allBooks.find(b => b.id === bookId);
      if(!book) return;
      
      document.getElementById('modal-book-title').textContent = book.title;
      document.getElementById('modal-book-author').textContent = book.author;
      document.getElementById('borrow-book-id').value = bookId;
      document.getElementById('borrow-book-title-hidden').value = book.title;
      
      document.getElementById('borrow-modal').style.display = 'flex';
    };

    window.closeBorrowModal = () => {
      document.getElementById('borrow-modal').style.display = 'none';
      document.getElementById('borrow-form').reset();
    };

    window.onclick = (event) => {
      const modal1 = document.getElementById('borrow-modal');
      const modal2 = document.getElementById('book-detail-modal');
      if (event.target == modal1) closeBorrowModal();
      if (event.target == modal2) closeBookDetail();
    };

    window.submitBorrowRequest = (e) => {
      e.preventDefault();
      
      const bookId = document.getElementById('borrow-book-id').value;
      const bookTitle = document.getElementById('borrow-book-title-hidden').value;
      const name = document.getElementById('borrow-name').value;
      const email = document.getElementById('borrow-email').value;
      const studentClass = document.getElementById('borrow-class').value;
      
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Duke dÃ«rguar...';
      submitBtn.disabled = true;

      const requestData = {
        bookId: bookId,
        bookTitle: bookTitle,
        userName: name,
        userEmail: email,
        userClass: studentClass,
        requestDate: new Date().toISOString(),
        status: 'pending'
      };

      // Save to both 'borrow_requests' and 'kerkesat' as requested
      const p1 = push(ref(db, 'borrow_requests'), requestData);
      const p2 = push(ref(db, 'kerkesat'), requestData);

      Promise.all([p1, p2])
      .then(() => {
        alert(`KÃ«rkesa pÃ«r librin "${bookTitle}" u dÃ«rgua me sukses!\nJu lutem paraqituni nÃ« bibliotekÃ« pÃ«r tÃ«rheqje.`);
        closeBorrowModal();
      })
      .catch((error) => {
        console.error("Error adding document: ", error);
        alert("Ndodhi njÃ« gabim gjatÃ« dÃ«rgimit tÃ« kÃ«rkesÃ«s. Ju lutem provoni pÃ«rsÃ«ri.");
      })
      .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      });
    };

    function fetchBooks() {
      onValue(ref(db, 'books'), (snap) => {
        if (snap.exists()) {
          const data = snap.val();
          allBooks = Object.entries(data).map(([key, val]) => ({ ...val, id: key }));
          resetAndFilter();
        } else {
          document.getElementById('guest-book-list').innerHTML = '<p style="grid-column: 1/-1; text-align:center;">Ende nuk ka libra nÃ« sistem.</p>';
          document.getElementById('total-count').textContent = '';
        }
      });
    }

    window.resetAndFilter = () => {
      filterGuestBooks();
    }

    window.filterGuestBooks = () => {
      const search = document.getElementById('guest-search').value.toLowerCase();
      const classFilter = document.getElementById('filter-class').value;
      const genreFilter = document.getElementById('filter-genre').value;
      const statusFilter = document.getElementById('filter-status').value;
      
      filteredBooks = allBooks.filter(b => {
        const matchSearch = (b.title || "").toLowerCase().includes(search) || (b.author || "").toLowerCase().includes(search);
        const matchClass = classFilter === 'all' || String(b.recommended) === String(classFilter);
        const matchGenre = genreFilter === 'all' || b.genre === genreFilter;
        
        let matchStatus = true;
        if (statusFilter === 'available') matchStatus = (b.quantity || 0) > 0;
        
        return matchSearch && matchClass && matchGenre && matchStatus;
      });

      renderGrid();
    };

    function renderGrid() {
      const list = document.getElementById('guest-book-list');
      const totalCountEl = document.getElementById('total-count');
      
      list.innerHTML = '';

      // Update Total Count
      totalCountEl.textContent = `Gjithsej: ${filteredBooks.length} libra`;
      
      if(filteredBooks.length === 0) {
        list.innerHTML = '<p style="grid-column: 1/-1; text-align:center; padding: 20px; font-size:1.1rem;">Nuk u gjet asnjÃ« libÃ«r me kÃ«to kritere.</p>';
        return;
      }

      // Render All Books (No Pagination)
      filteredBooks.forEach(book => {
        const qty = book.quantity || 0;
        const statusBadge = qty > 0 
          ? `<span class="badge" style="background:#e8f5e9; color:#2e7d32;">E Disponueshme (${qty})</span>` 
          : `<span class="badge" style="background:#ffebee; color:#c62828;">E ZÃ«nÃ«</span>`;

        const div = document.createElement('div');
        div.className = 'book-card';
        div.onclick = () => openBookDetail(book.id);
        
        div.innerHTML = `
          <div class="book-icon"><i class="fas fa-book"></i></div>
          <div class="book-content">
            <div class="book-title">${escapeHtml(book.title)}</div>
            <div class="book-author">${escapeHtml(book.author)}</div>
          </div>
          ${statusBadge}
        `;
        list.appendChild(div);
      });
    }
  </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
